{"ast":null,"code":"/**\n * Copyright 2023 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { ElementHandle } from '../api/ElementHandle.js';\nimport { assert } from '../util/assert.js';\nimport { isErrorLike } from '../util/ErrorLike.js';\nimport { interpolateFunction, stringifyFunction } from '../util/Function.js';\nimport { AbortError } from './Errors.js';\nimport { transposeIterableHandle } from './HandleIterator.js';\nimport { MAIN_WORLD, PUPPETEER_WORLD } from './IsolatedWorlds.js';\nimport { LazyArg } from './LazyArg.js';\n/**\n * @internal\n */\nexport class QueryHandler {\n  static get _querySelector() {\n    if (this.querySelector) {\n      return this.querySelector;\n    }\n    if (!this.querySelectorAll) {\n      throw new Error('Cannot create default `querySelector`.');\n    }\n    return this.querySelector = interpolateFunction(async (node, selector, PuppeteerUtil) => {\n      const querySelectorAll = PLACEHOLDER('querySelectorAll');\n      const results = querySelectorAll(node, selector, PuppeteerUtil);\n      for await (const result of results) {\n        return result;\n      }\n      return null;\n    }, {\n      querySelectorAll: stringifyFunction(this.querySelectorAll)\n    });\n  }\n  static get _querySelectorAll() {\n    if (this.querySelectorAll) {\n      return this.querySelectorAll;\n    }\n    if (!this.querySelector) {\n      throw new Error('Cannot create default `querySelectorAll`.');\n    }\n    return this.querySelectorAll = interpolateFunction(async function* (node, selector, PuppeteerUtil) {\n      const querySelector = PLACEHOLDER('querySelector');\n      const result = await querySelector(node, selector, PuppeteerUtil);\n      if (result) {\n        yield result;\n      }\n    }, {\n      querySelector: stringifyFunction(this.querySelector)\n    });\n  }\n  /**\n   * Queries for multiple nodes given a selector and {@link ElementHandle}.\n   *\n   * Akin to {@link https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelectorAll | Document.querySelectorAll()}.\n   */\n  static async *queryAll(element, selector) {\n    const world = element.executionContext()._world;\n    assert(world);\n    const handle = await element.evaluateHandle(this._querySelectorAll, selector, LazyArg.create(context => {\n      return context.puppeteerUtil;\n    }));\n    yield* transposeIterableHandle(handle);\n  }\n  /**\n   * Queries for a single node given a selector and {@link ElementHandle}.\n   *\n   * Akin to {@link https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelector}.\n   */\n  static async queryOne(element, selector) {\n    const world = element.executionContext()._world;\n    assert(world);\n    const result = await element.evaluateHandle(this._querySelector, selector, LazyArg.create(context => {\n      return context.puppeteerUtil;\n    }));\n    if (!(result instanceof ElementHandle)) {\n      await result.dispose();\n      return null;\n    }\n    return result;\n  }\n  /**\n   * Waits until a single node appears for a given selector and\n   * {@link ElementHandle}.\n   *\n   * This will always query the handle in the Puppeteer world and migrate the\n   * result to the main world.\n   */\n  static async waitFor(elementOrFrame, selector, options) {\n    let frame;\n    let element;\n    if (!(elementOrFrame instanceof ElementHandle)) {\n      frame = elementOrFrame;\n    } else {\n      frame = elementOrFrame.frame;\n      element = await frame.worlds[PUPPETEER_WORLD].adoptHandle(elementOrFrame);\n    }\n    const {\n      visible = false,\n      hidden = false,\n      timeout,\n      signal\n    } = options;\n    try {\n      if (signal === null || signal === void 0 ? void 0 : signal.aborted) {\n        throw new AbortError('QueryHander.waitFor has been aborted.');\n      }\n      const handle = await frame.worlds[PUPPETEER_WORLD].waitForFunction(async (PuppeteerUtil, query, selector, root, visible) => {\n        const querySelector = PuppeteerUtil.createFunction(query);\n        const node = await querySelector(root !== null && root !== void 0 ? root : document, selector, PuppeteerUtil);\n        return PuppeteerUtil.checkVisibility(node, visible);\n      }, {\n        polling: visible || hidden ? 'raf' : 'mutation',\n        root: element,\n        timeout,\n        signal\n      }, LazyArg.create(context => {\n        return context.puppeteerUtil;\n      }), stringifyFunction(this._querySelector), selector, element, visible ? true : hidden ? false : undefined);\n      if (signal === null || signal === void 0 ? void 0 : signal.aborted) {\n        await handle.dispose();\n        throw new AbortError('QueryHander.waitFor has been aborted.');\n      }\n      if (!(handle instanceof ElementHandle)) {\n        await handle.dispose();\n        return null;\n      }\n      return frame.worlds[MAIN_WORLD].transferHandle(handle);\n    } catch (error) {\n      if (!isErrorLike(error)) {\n        throw error;\n      }\n      error.message = `Waiting for selector \\`${selector}\\` failed: ${error.message}`;\n      throw error;\n    } finally {\n      if (element) {\n        await element.dispose();\n      }\n    }\n  }\n}","map":{"version":3,"names":["ElementHandle","assert","isErrorLike","interpolateFunction","stringifyFunction","AbortError","transposeIterableHandle","MAIN_WORLD","PUPPETEER_WORLD","LazyArg","QueryHandler","_querySelector","querySelector","querySelectorAll","Error","node","selector","PuppeteerUtil","PLACEHOLDER","results","result","_querySelectorAll","queryAll","element","world","executionContext","_world","handle","evaluateHandle","create","context","puppeteerUtil","queryOne","dispose","waitFor","elementOrFrame","options","frame","worlds","adoptHandle","visible","hidden","timeout","signal","aborted","waitForFunction","query","root","createFunction","document","checkVisibility","polling","undefined","transferHandle","error","message"],"sources":["../../../../src/common/QueryHandler.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}