{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2017 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.canDownload = exports.install = void 0;\nconst assert_1 = __importDefault(require(\"assert\"));\nconst fs_1 = require(\"fs\");\nconst promises_1 = require(\"fs/promises\");\nconst os_1 = __importDefault(require(\"os\"));\nconst path_1 = __importDefault(require(\"path\"));\nconst browser_data_js_1 = require(\"./browser-data/browser-data.js\");\nconst Cache_js_1 = require(\"./Cache.js\");\nconst debug_js_1 = require(\"./debug.js\");\nconst detectPlatform_js_1 = require(\"./detectPlatform.js\");\nconst fileUtil_js_1 = require(\"./fileUtil.js\");\nconst httpUtil_js_1 = require(\"./httpUtil.js\");\nconst debugInstall = (0, debug_js_1.debug)('puppeteer:browsers:install');\nconst times = new Map();\nfunction debugTime(label) {\n  times.set(label, process.hrtime());\n}\nfunction debugTimeEnd(label) {\n  const end = process.hrtime();\n  const start = times.get(label);\n  if (!start) {\n    return;\n  }\n  const duration = end[0] * 1000 + end[1] / 1e6 - (start[0] * 1000 + start[1] / 1e6); // calculate duration in milliseconds\n  debugInstall(`Duration for ${label}: ${duration}ms`);\n}\n/**\n * @public\n */\nasync function install(options) {\n  var _a, _b;\n  (_a = options.platform) !== null && _a !== void 0 ? _a : options.platform = (0, detectPlatform_js_1.detectBrowserPlatform)();\n  (_b = options.unpack) !== null && _b !== void 0 ? _b : options.unpack = true;\n  if (!options.platform) {\n    throw new Error(`Cannot download a binary for the provided platform: ${os_1.default.platform()} (${os_1.default.arch()})`);\n  }\n  const url = getDownloadUrl(options.browser, options.platform, options.buildId, options.baseUrl);\n  const fileName = url.toString().split('/').pop();\n  (0, assert_1.default)(fileName, `A malformed download URL was found: ${url}.`);\n  const structure = new Cache_js_1.Cache(options.cacheDir);\n  const browserRoot = structure.browserRoot(options.browser);\n  const archivePath = path_1.default.join(browserRoot, fileName);\n  if (!(0, fs_1.existsSync)(browserRoot)) {\n    await (0, promises_1.mkdir)(browserRoot, {\n      recursive: true\n    });\n  }\n  if (!options.unpack) {\n    if ((0, fs_1.existsSync)(archivePath)) {\n      return {\n        path: archivePath,\n        browser: options.browser,\n        platform: options.platform,\n        buildId: options.buildId\n      };\n    }\n    debugInstall(`Downloading binary from ${url}`);\n    debugTime('download');\n    await (0, httpUtil_js_1.downloadFile)(url, archivePath, options.downloadProgressCallback);\n    debugTimeEnd('download');\n    return {\n      path: archivePath,\n      browser: options.browser,\n      platform: options.platform,\n      buildId: options.buildId\n    };\n  }\n  const outputPath = structure.installationDir(options.browser, options.platform, options.buildId);\n  if ((0, fs_1.existsSync)(outputPath)) {\n    return {\n      path: outputPath,\n      browser: options.browser,\n      platform: options.platform,\n      buildId: options.buildId\n    };\n  }\n  try {\n    debugInstall(`Downloading binary from ${url}`);\n    try {\n      debugTime('download');\n      await (0, httpUtil_js_1.downloadFile)(url, archivePath, options.downloadProgressCallback);\n    } finally {\n      debugTimeEnd('download');\n    }\n    debugInstall(`Installing ${archivePath} to ${outputPath}`);\n    try {\n      debugTime('extract');\n      await (0, fileUtil_js_1.unpackArchive)(archivePath, outputPath);\n    } finally {\n      debugTimeEnd('extract');\n    }\n  } finally {\n    if ((0, fs_1.existsSync)(archivePath)) {\n      await (0, promises_1.unlink)(archivePath);\n    }\n  }\n  return {\n    path: outputPath,\n    browser: options.browser,\n    platform: options.platform,\n    buildId: options.buildId\n  };\n}\nexports.install = install;\n/**\n * @public\n */\nasync function canDownload(options) {\n  var _a;\n  (_a = options.platform) !== null && _a !== void 0 ? _a : options.platform = (0, detectPlatform_js_1.detectBrowserPlatform)();\n  if (!options.platform) {\n    throw new Error(`Cannot download a binary for the provided platform: ${os_1.default.platform()} (${os_1.default.arch()})`);\n  }\n  return await (0, httpUtil_js_1.headHttpRequest)(getDownloadUrl(options.browser, options.platform, options.buildId, options.baseUrl));\n}\nexports.canDownload = canDownload;\nfunction getDownloadUrl(browser, platform, buildId, baseUrl) {\n  return new URL(browser_data_js_1.downloadUrls[browser](platform, buildId, baseUrl));\n}","map":{"version":3,"names":["assert_1","__importDefault","require","fs_1","promises_1","os_1","path_1","browser_data_js_1","Cache_js_1","debug_js_1","detectPlatform_js_1","fileUtil_js_1","httpUtil_js_1","debugInstall","debug","times","Map","debugTime","label","set","process","hrtime","debugTimeEnd","end","start","get","duration","install","options","_a","platform","detectBrowserPlatform","_b","unpack","Error","default","arch","url","getDownloadUrl","browser","buildId","baseUrl","fileName","toString","split","pop","structure","Cache","cacheDir","browserRoot","archivePath","join","existsSync","mkdir","recursive","path","downloadFile","downloadProgressCallback","outputPath","installationDir","unpackArchive","unlink","exports","canDownload","headHttpRequest","URL","downloadUrls"],"sources":["../../src/install.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}