{"ast":null,"code":"/**\n * Copyright 2023 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { createWriteStream } from 'fs';\nimport * as http from 'http';\nimport * as https from 'https';\nimport { URL } from 'url';\nimport createHttpsProxyAgent from 'https-proxy-agent';\nimport { getProxyForUrl } from 'proxy-from-env';\nexport function headHttpRequest(url) {\n  return new Promise(resolve => {\n    const request = httpRequest(url, 'HEAD', response => {\n      resolve(response.statusCode === 200);\n    }, false);\n    request.on('error', () => {\n      resolve(false);\n    });\n  });\n}\nexport function httpRequest(url, method, response, keepAlive = true) {\n  const options = {\n    protocol: url.protocol,\n    hostname: url.hostname,\n    port: url.port,\n    path: url.pathname + url.search,\n    method,\n    headers: keepAlive ? {\n      Connection: 'keep-alive'\n    } : undefined\n  };\n  const proxyURL = getProxyForUrl(url.toString());\n  if (proxyURL) {\n    const proxy = new URL(proxyURL);\n    if (proxy.protocol === 'http:') {\n      options.path = url.href;\n      options.hostname = proxy.hostname;\n      options.protocol = proxy.protocol;\n      options.port = proxy.port;\n    } else {\n      options.agent = createHttpsProxyAgent({\n        host: proxy.host,\n        path: proxy.pathname,\n        port: proxy.port,\n        secureProxy: proxy.protocol === 'https:',\n        headers: options.headers\n      });\n    }\n  }\n  const requestCallback = res => {\n    if (res.statusCode && res.statusCode >= 300 && res.statusCode < 400 && res.headers.location) {\n      httpRequest(new URL(res.headers.location), method, response);\n    } else {\n      response(res);\n    }\n  };\n  const request = options.protocol === 'https:' ? https.request(options, requestCallback) : http.request(options, requestCallback);\n  request.end();\n  return request;\n}\n/**\n * @internal\n */\nexport function downloadFile(url, destinationPath, progressCallback) {\n  return new Promise((resolve, reject) => {\n    let downloadedBytes = 0;\n    let totalBytes = 0;\n    function onData(chunk) {\n      downloadedBytes += chunk.length;\n      progressCallback(downloadedBytes, totalBytes);\n    }\n    const request = httpRequest(url, 'GET', response => {\n      if (response.statusCode !== 200) {\n        const error = new Error(`Download failed: server returned code ${response.statusCode}. URL: ${url}`);\n        // consume response data to free up memory\n        response.resume();\n        reject(error);\n        return;\n      }\n      const file = createWriteStream(destinationPath);\n      file.on('finish', () => {\n        return resolve();\n      });\n      file.on('error', error => {\n        return reject(error);\n      });\n      response.pipe(file);\n      totalBytes = parseInt(response.headers['content-length'], 10);\n      if (progressCallback) {\n        response.on('data', onData);\n      }\n    });\n    request.on('error', error => {\n      return reject(error);\n    });\n  });\n}","map":{"version":3,"names":["createWriteStream","http","https","URL","createHttpsProxyAgent","getProxyForUrl","headHttpRequest","url","Promise","resolve","request","httpRequest","response","statusCode","on","method","keepAlive","options","protocol","hostname","port","path","pathname","search","headers","Connection","undefined","proxyURL","toString","proxy","href","agent","host","secureProxy","requestCallback","res","location","end","downloadFile","destinationPath","progressCallback","reject","downloadedBytes","totalBytes","onData","chunk","length","error","Error","resume","file","pipe","parseInt"],"sources":["../../src/httpUtil.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}