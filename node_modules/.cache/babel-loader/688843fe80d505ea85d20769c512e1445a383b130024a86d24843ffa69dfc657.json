{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2023 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar __classPrivateFieldSet = this && this.__classPrivateFieldSet || function (receiver, state, value, kind, f) {\n  if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\n  return kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value), value;\n};\nvar __classPrivateFieldGet = this && this.__classPrivateFieldGet || function (receiver, state, kind, f) {\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\n  return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\n};\nvar _Context_instances, _Context_connection, _Context_url, _Context_evaluate;\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.getBidiHandle = exports.Context = void 0;\nconst assert_js_1 = require(\"../../util/assert.js\");\nconst Function_js_1 = require(\"../../util/Function.js\");\nconst Errors_js_1 = require(\"../Errors.js\");\nconst EventEmitter_js_1 = require(\"../EventEmitter.js\");\nconst TimeoutSettings_js_1 = require(\"../TimeoutSettings.js\");\nconst util_js_1 = require(\"../util.js\");\nconst ElementHandle_js_1 = require(\"./ElementHandle.js\");\nconst JSHandle_js_1 = require(\"./JSHandle.js\");\nconst Serializer_js_1 = require(\"./Serializer.js\");\n/**\n * @internal\n */\nconst lifeCycleToReadinessState = new Map([['load', 'complete'], ['domcontentloaded', 'interactive']]);\n/**\n * @internal\n */\nconst lifeCycleToSubscribedEvent = new Map([['load', 'browsingContext.load'], ['domcontentloaded', 'browsingContext.domContentLoaded']]);\n/**\n * @internal\n */\nclass Context extends EventEmitter_js_1.EventEmitter {\n  constructor(connection, result) {\n    super();\n    _Context_instances.add(this);\n    _Context_connection.set(this, void 0);\n    _Context_url.set(this, void 0);\n    this._timeoutSettings = new TimeoutSettings_js_1.TimeoutSettings();\n    __classPrivateFieldSet(this, _Context_connection, connection, \"f\");\n    this._contextId = result.context;\n    __classPrivateFieldSet(this, _Context_url, result.url, \"f\");\n  }\n  get connection() {\n    return __classPrivateFieldGet(this, _Context_connection, \"f\");\n  }\n  get id() {\n    return this._contextId;\n  }\n  async evaluateHandle(pageFunction, ...args) {\n    return __classPrivateFieldGet(this, _Context_instances, \"m\", _Context_evaluate).call(this, false, pageFunction, ...args);\n  }\n  async evaluate(pageFunction, ...args) {\n    return __classPrivateFieldGet(this, _Context_instances, \"m\", _Context_evaluate).call(this, true, pageFunction, ...args);\n  }\n  async goto(url, options = {}) {\n    const {\n      waitUntil = 'load',\n      timeout = this._timeoutSettings.navigationTimeout()\n    } = options;\n    const readinessState = lifeCycleToReadinessState.get(getWaitUntilSingle(waitUntil));\n    try {\n      const response = await (0, util_js_1.waitWithTimeout)(this.connection.send('browsingContext.navigate', {\n        url: url,\n        context: this.id,\n        wait: readinessState\n      }), 'Navigation', timeout);\n      __classPrivateFieldSet(this, _Context_url, response.result.url, \"f\");\n      return null;\n    } catch (error) {\n      if (error instanceof Errors_js_1.ProtocolError) {\n        error.message += ` at ${url}`;\n      } else if (error instanceof Errors_js_1.TimeoutError) {\n        error.message = 'Navigation timeout of ' + timeout + ' ms exceeded';\n      }\n      throw error;\n    }\n  }\n  url() {\n    return __classPrivateFieldGet(this, _Context_url, \"f\");\n  }\n  async setContent(html, options = {}) {\n    const {\n      waitUntil = 'load',\n      timeout = this._timeoutSettings.navigationTimeout()\n    } = options;\n    const waitUntilCommand = lifeCycleToSubscribedEvent.get(getWaitUntilSingle(waitUntil));\n    await Promise.all([(0, util_js_1.setPageContent)(this, html), (0, util_js_1.waitWithTimeout)(new Promise(resolve => {\n      this.once(waitUntilCommand, () => {\n        resolve();\n      });\n    }), waitUntilCommand, timeout)]);\n  }\n}\nexports.Context = Context;\n_Context_connection = new WeakMap(), _Context_url = new WeakMap(), _Context_instances = new WeakSet(), _Context_evaluate = async function _Context_evaluate(returnByValue, pageFunction, ...args) {\n  let responsePromise;\n  const resultOwnership = returnByValue ? 'none' : 'root';\n  if ((0, util_js_1.isString)(pageFunction)) {\n    responsePromise = __classPrivateFieldGet(this, _Context_connection, \"f\").send('script.evaluate', {\n      expression: pageFunction,\n      target: {\n        context: this._contextId\n      },\n      resultOwnership,\n      awaitPromise: true\n    });\n  } else {\n    responsePromise = __classPrivateFieldGet(this, _Context_connection, \"f\").send('script.callFunction', {\n      functionDeclaration: (0, Function_js_1.stringifyFunction)(pageFunction),\n      arguments: await Promise.all(args.map(arg => {\n        return Serializer_js_1.BidiSerializer.serialize(arg, this);\n      })),\n      target: {\n        context: this._contextId\n      },\n      resultOwnership,\n      awaitPromise: true\n    });\n  }\n  const {\n    result\n  } = await responsePromise;\n  if ('type' in result && result.type === 'exception') {\n    throw new Error(result.exceptionDetails.text);\n  }\n  return returnByValue ? Serializer_js_1.BidiSerializer.deserialize(result.result) : getBidiHandle(this, result.result);\n};\n/**\n * @internal\n */\nfunction getWaitUntilSingle(event) {\n  if (Array.isArray(event) && event.length > 1) {\n    throw new Error('BiDi support only single `waitUntil` argument');\n  }\n  const waitUntilSingle = Array.isArray(event) ? event.find(lifecycle => {\n    return lifecycle === 'domcontentloaded' || lifecycle === 'load';\n  }) : event;\n  if (waitUntilSingle === 'networkidle0' || waitUntilSingle === 'networkidle2') {\n    throw new Error(`BiDi does not support 'waitUntil' ${waitUntilSingle}`);\n  }\n  (0, assert_js_1.assert)(waitUntilSingle, `Invalid waitUntil option ${waitUntilSingle}`);\n  return waitUntilSingle;\n}\n/**\n * @internal\n */\nfunction getBidiHandle(context, result) {\n  if (result.type === 'node' || result.type === 'window') {\n    return new ElementHandle_js_1.ElementHandle(context, result);\n  }\n  return new JSHandle_js_1.JSHandle(context, result);\n}\nexports.getBidiHandle = getBidiHandle;","map":{"version":3,"names":["assert_js_1","require","Function_js_1","Errors_js_1","EventEmitter_js_1","TimeoutSettings_js_1","util_js_1","ElementHandle_js_1","JSHandle_js_1","Serializer_js_1","lifeCycleToReadinessState","Map","lifeCycleToSubscribedEvent","Context","EventEmitter","constructor","connection","result","_Context_connection","set","_Context_url","_timeoutSettings","TimeoutSettings","__classPrivateFieldSet","_contextId","context","url","__classPrivateFieldGet","id","evaluateHandle","pageFunction","args","_Context_instances","_Context_evaluate","call","evaluate","goto","options","waitUntil","timeout","navigationTimeout","readinessState","get","getWaitUntilSingle","response","waitWithTimeout","send","wait","error","ProtocolError","message","TimeoutError","setContent","html","waitUntilCommand","Promise","all","setPageContent","resolve","once","exports","returnByValue","responsePromise","resultOwnership","isString","expression","target","awaitPromise","functionDeclaration","stringifyFunction","arguments","map","arg","BidiSerializer","serialize","type","Error","exceptionDetails","text","deserialize","getBidiHandle","event","Array","isArray","length","waitUntilSingle","find","lifecycle","assert","ElementHandle","JSHandle"],"sources":["../../../../../src/common/bidi/Context.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}