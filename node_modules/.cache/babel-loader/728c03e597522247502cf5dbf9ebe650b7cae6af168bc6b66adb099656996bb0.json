{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2022 Google LLC.\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Realm = void 0;\nconst scriptEvaluator_js_1 = require(\"./scriptEvaluator.js\");\nclass Realm {\n  #realmStorage;\n  #browsingContextStorage;\n  #realmId;\n  #browsingContextId;\n  #executionContextId;\n  #origin;\n  #type;\n  #cdpClient;\n  #eventManager;\n  #scriptEvaluator;\n  sandbox;\n  cdpSessionId;\n  constructor(realmStorage, browsingContextStorage, realmId, browsingContextId, executionContextId, origin, type, sandbox, cdpSessionId, cdpClient, eventManager) {\n    this.#realmId = realmId;\n    this.#browsingContextId = browsingContextId;\n    this.#executionContextId = executionContextId;\n    this.sandbox = sandbox;\n    this.#origin = origin;\n    this.#type = type;\n    this.cdpSessionId = cdpSessionId;\n    this.#cdpClient = cdpClient;\n    this.#realmStorage = realmStorage;\n    this.#browsingContextStorage = browsingContextStorage;\n    this.#eventManager = eventManager;\n    this.#scriptEvaluator = new scriptEvaluator_js_1.ScriptEvaluator(this.#eventManager);\n    this.#realmStorage.realmMap.set(this.#realmId, this);\n  }\n  async disown(handle) {\n    // Disowning an object from different realm does nothing.\n    if (this.#realmStorage.knownHandlesToRealm.get(handle) !== this.realmId) {\n      return;\n    }\n    try {\n      await this.cdpClient.sendCommand('Runtime.releaseObject', {\n        objectId: handle\n      });\n    } catch (e) {\n      // Heuristic to determine if the problem is in the unknown handler.\n      // Ignore the error if so.\n      if (!(e.code === -32000 && e.message === 'Invalid remote object id')) {\n        throw e;\n      }\n    }\n    this.#realmStorage.knownHandlesToRealm.delete(handle);\n  }\n  cdpToBidiValue(cdpValue, resultOwnership) {\n    const cdpWebDriverValue = cdpValue.result.webDriverValue;\n    const bidiValue = this.webDriverValueToBiDi(cdpWebDriverValue);\n    if (cdpValue.result.objectId) {\n      const objectId = cdpValue.result.objectId;\n      if (resultOwnership === 'root') {\n        // Extend BiDi value with `handle` based on required `resultOwnership`\n        // and  CDP response but not on the actual BiDi type.\n        bidiValue.handle = objectId;\n        // Remember all the handles sent to client.\n        this.#realmStorage.knownHandlesToRealm.set(objectId, this.realmId);\n      } else {\n        // No need in awaiting for the object to be released.\n        void this.cdpClient.sendCommand('Runtime.releaseObject', {\n          objectId\n        });\n      }\n    }\n    return bidiValue;\n  }\n  webDriverValueToBiDi(webDriverValue) {\n    // This relies on the CDP to implement proper BiDi serialization, except\n    // backendNodeId/sharedId and `platformobject`.\n    const result = webDriverValue;\n    // Platform object is a special case. It should have only `{type: object}`\n    // without `value` field.\n    if (result.type === 'platformobject') {\n      return {\n        type: 'object'\n      };\n    }\n    const bidiValue = result.value;\n    if (bidiValue === undefined) {\n      return result;\n    }\n    if (result.type === 'node') {\n      if (Object.hasOwn(bidiValue, 'backendNodeId')) {\n        // eslint-disable-next-line @typescript-eslint/restrict-template-expressions\n        bidiValue.sharedId = `${this.navigableId}${scriptEvaluator_js_1.SHARED_ID_DIVIDER}${bidiValue.backendNodeId}`;\n        delete bidiValue['backendNodeId'];\n      }\n      if (Object.hasOwn(bidiValue, 'children')) {\n        for (const i in bidiValue.children) {\n          bidiValue.children[i] = this.webDriverValueToBiDi(bidiValue.children[i]);\n        }\n      }\n    }\n    // Recursively update the nested values.\n    if (['array', 'set'].includes(webDriverValue.type)) {\n      for (const i in bidiValue) {\n        bidiValue[i] = this.webDriverValueToBiDi(bidiValue[i]);\n      }\n    }\n    if (['object', 'map'].includes(webDriverValue.type)) {\n      for (const i in bidiValue) {\n        bidiValue[i] = [this.webDriverValueToBiDi(bidiValue[i][0]), this.webDriverValueToBiDi(bidiValue[i][1])];\n      }\n    }\n    return result;\n  }\n  toBiDi() {\n    return {\n      realm: this.realmId,\n      origin: this.origin,\n      type: this.type,\n      context: this.browsingContextId,\n      ...(this.sandbox === undefined ? {} : {\n        sandbox: this.sandbox\n      })\n    };\n  }\n  get realmId() {\n    return this.#realmId;\n  }\n  get navigableId() {\n    return this.#browsingContextStorage.findContext(this.#browsingContextId)?.navigableId ?? 'UNKNOWN';\n  }\n  get browsingContextId() {\n    return this.#browsingContextId;\n  }\n  get executionContextId() {\n    return this.#executionContextId;\n  }\n  get origin() {\n    return this.#origin;\n  }\n  get type() {\n    return this.#type;\n  }\n  get cdpClient() {\n    return this.#cdpClient;\n  }\n  async callFunction(functionDeclaration, _this, _arguments, awaitPromise, resultOwnership) {\n    const context = this.#browsingContextStorage.getContext(this.browsingContextId);\n    await context.awaitUnblocked();\n    return {\n      result: await this.#scriptEvaluator.callFunction(this, functionDeclaration, _this, _arguments, awaitPromise, resultOwnership)\n    };\n  }\n  async scriptEvaluate(expression, awaitPromise, resultOwnership) {\n    const context = this.#browsingContextStorage.getContext(this.browsingContextId);\n    await context.awaitUnblocked();\n    return {\n      result: await this.#scriptEvaluator.scriptEvaluate(this, expression, awaitPromise, resultOwnership)\n    };\n  }\n  /**\n   * Serializes a given CDP object into BiDi, keeping references in the\n   * target's `globalThis`.\n   * @param cdpObject CDP remote object to be serialized.\n   * @param resultOwnership Indicates desired ResultOwnership.\n   */\n  async serializeCdpObject(cdpObject, resultOwnership) {\n    return this.#scriptEvaluator.serializeCdpObject(cdpObject, resultOwnership, this);\n  }\n  /**\n   * Gets the string representation of an object. This is equivalent to\n   * calling toString() on the object value.\n   * @param cdpObject CDP remote object representing an object.\n   * @return string The stringified object.\n   */\n  async stringifyObject(cdpObject) {\n    return scriptEvaluator_js_1.ScriptEvaluator.stringifyObject(cdpObject, this);\n  }\n}\nexports.Realm = Realm;","map":{"version":3,"names":["scriptEvaluator_js_1","require","Realm","realmStorage","browsingContextStorage","realmId","browsingContextId","executionContextId","origin","type","cdpClient","eventManager","scriptEvaluator","sandbox","cdpSessionId","constructor","ScriptEvaluator","realmMap","set","disown","handle","knownHandlesToRealm","get","sendCommand","objectId","e","code","message","delete","cdpToBidiValue","cdpValue","resultOwnership","cdpWebDriverValue","result","webDriverValue","bidiValue","webDriverValueToBiDi","value","undefined","Object","hasOwn","sharedId","navigableId","SHARED_ID_DIVIDER","backendNodeId","i","children","includes","toBiDi","realm","context","findContext","callFunction","functionDeclaration","_this","_arguments","awaitPromise","getContext","awaitUnblocked","scriptEvaluate","expression","serializeCdpObject","cdpObject","stringifyObject","exports"],"sources":["../../../../../src/bidiMapper/domains/script/realm.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}