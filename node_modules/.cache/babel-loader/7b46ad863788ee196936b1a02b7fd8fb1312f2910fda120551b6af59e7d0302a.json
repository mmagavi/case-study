{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2017 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar __classPrivateFieldSet = this && this.__classPrivateFieldSet || function (receiver, state, value, kind, f) {\n  if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\n  return kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value), value;\n};\nvar __classPrivateFieldGet = this && this.__classPrivateFieldGet || function (receiver, state, kind, f) {\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\n  return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\n};\nvar _Connection_instances, _Connection_transport, _Connection_delay, _Connection_timeout, _Connection_closed, _Connection_callbacks, _Connection_contexts, _Connection_maybeEmitOnContext, _Connection_handleSpecialEvents, _Connection_onClose;\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Connection = void 0;\nconst Connection_js_1 = require(\"../Connection.js\");\nconst Debug_js_1 = require(\"../Debug.js\");\nconst EventEmitter_js_1 = require(\"../EventEmitter.js\");\nconst Context_js_1 = require(\"./Context.js\");\nconst debugProtocolSend = (0, Debug_js_1.debug)('puppeteer:webDriverBiDi:SEND ►');\nconst debugProtocolReceive = (0, Debug_js_1.debug)('puppeteer:webDriverBiDi:RECV ◀');\n/**\n * @internal\n */\nclass Connection extends EventEmitter_js_1.EventEmitter {\n  constructor(transport, delay = 0, timeout) {\n    super();\n    _Connection_instances.add(this);\n    _Connection_transport.set(this, void 0);\n    _Connection_delay.set(this, void 0);\n    _Connection_timeout.set(this, 0);\n    _Connection_closed.set(this, false);\n    _Connection_callbacks.set(this, new Connection_js_1.CallbackRegistry());\n    _Connection_contexts.set(this, new Map());\n    __classPrivateFieldSet(this, _Connection_delay, delay, \"f\");\n    __classPrivateFieldSet(this, _Connection_timeout, timeout !== null && timeout !== void 0 ? timeout : 180000, \"f\");\n    __classPrivateFieldSet(this, _Connection_transport, transport, \"f\");\n    __classPrivateFieldGet(this, _Connection_transport, \"f\").onmessage = this.onMessage.bind(this);\n    __classPrivateFieldGet(this, _Connection_transport, \"f\").onclose = __classPrivateFieldGet(this, _Connection_instances, \"m\", _Connection_onClose).bind(this);\n  }\n  get closed() {\n    return __classPrivateFieldGet(this, _Connection_closed, \"f\");\n  }\n  context(contextId) {\n    return __classPrivateFieldGet(this, _Connection_contexts, \"f\").get(contextId) || null;\n  }\n  send(method, params) {\n    return __classPrivateFieldGet(this, _Connection_callbacks, \"f\").create(method, __classPrivateFieldGet(this, _Connection_timeout, \"f\"), id => {\n      const stringifiedMessage = JSON.stringify({\n        id,\n        method,\n        params\n      });\n      debugProtocolSend(stringifiedMessage);\n      __classPrivateFieldGet(this, _Connection_transport, \"f\").send(stringifiedMessage);\n    });\n  }\n  /**\n   * @internal\n   */\n  async onMessage(message) {\n    if (__classPrivateFieldGet(this, _Connection_delay, \"f\")) {\n      await new Promise(f => {\n        return setTimeout(f, __classPrivateFieldGet(this, _Connection_delay, \"f\"));\n      });\n    }\n    debugProtocolReceive(message);\n    const object = JSON.parse(message);\n    if ('id' in object) {\n      if ('error' in object) {\n        __classPrivateFieldGet(this, _Connection_callbacks, \"f\").reject(object.id, createProtocolError(object), object.message);\n      } else {\n        __classPrivateFieldGet(this, _Connection_callbacks, \"f\").resolve(object.id, object);\n      }\n    } else {\n      __classPrivateFieldGet(this, _Connection_instances, \"m\", _Connection_handleSpecialEvents).call(this, object);\n      __classPrivateFieldGet(this, _Connection_instances, \"m\", _Connection_maybeEmitOnContext).call(this, object);\n      this.emit(object.method, object.params);\n    }\n  }\n  dispose() {\n    __classPrivateFieldGet(this, _Connection_instances, \"m\", _Connection_onClose).call(this);\n    __classPrivateFieldGet(this, _Connection_transport, \"f\").close();\n  }\n}\nexports.Connection = Connection;\n_Connection_transport = new WeakMap(), _Connection_delay = new WeakMap(), _Connection_timeout = new WeakMap(), _Connection_closed = new WeakMap(), _Connection_callbacks = new WeakMap(), _Connection_contexts = new WeakMap(), _Connection_instances = new WeakSet(), _Connection_maybeEmitOnContext = function _Connection_maybeEmitOnContext(event) {\n  let context;\n  // Context specific events\n  if ('context' in event.params && event.params.context) {\n    context = __classPrivateFieldGet(this, _Connection_contexts, \"f\").get(event.params.context);\n    // `log.entryAdded` specific context\n  } else if ('source' in event.params && event.params.source.context) {\n    context = __classPrivateFieldGet(this, _Connection_contexts, \"f\").get(event.params.source.context);\n  }\n  context === null || context === void 0 ? void 0 : context.emit(event.method, event.params);\n}, _Connection_handleSpecialEvents = function _Connection_handleSpecialEvents(event) {\n  switch (event.method) {\n    case 'browsingContext.contextCreated':\n      __classPrivateFieldGet(this, _Connection_contexts, \"f\").set(event.params.context, new Context_js_1.Context(this, event.params));\n  }\n}, _Connection_onClose = function _Connection_onClose() {\n  if (__classPrivateFieldGet(this, _Connection_closed, \"f\")) {\n    return;\n  }\n  __classPrivateFieldSet(this, _Connection_closed, true, \"f\");\n  __classPrivateFieldGet(this, _Connection_transport, \"f\").onmessage = undefined;\n  __classPrivateFieldGet(this, _Connection_transport, \"f\").onclose = undefined;\n  __classPrivateFieldGet(this, _Connection_callbacks, \"f\").clear();\n};\n/**\n * @internal\n */\nfunction createProtocolError(object) {\n  let message = `${object.error} ${object.message}`;\n  if (object.stacktrace) {\n    message += ` ${object.stacktrace}`;\n  }\n  return message;\n}","map":{"version":3,"names":["Connection_js_1","require","Debug_js_1","EventEmitter_js_1","Context_js_1","debugProtocolSend","debug","debugProtocolReceive","Connection","EventEmitter","constructor","transport","delay","timeout","_Connection_transport","set","_Connection_delay","_Connection_timeout","_Connection_closed","_Connection_callbacks","CallbackRegistry","_Connection_contexts","Map","__classPrivateFieldSet","__classPrivateFieldGet","onmessage","onMessage","bind","onclose","_Connection_instances","_Connection_onClose","closed","context","contextId","get","send","method","params","create","id","stringifiedMessage","JSON","stringify","message","Promise","f","setTimeout","object","parse","reject","createProtocolError","resolve","_Connection_handleSpecialEvents","call","_Connection_maybeEmitOnContext","emit","dispose","close","exports","event","source","Context","undefined","clear","error","stacktrace"],"sources":["../../../../../src/common/bidi/Connection.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}