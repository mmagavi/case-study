{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2023 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.BidiSerializer = void 0;\nconst util_js_1 = require(\"../util.js\");\nconst ElementHandle_js_1 = require(\"./ElementHandle.js\");\nconst JSHandle_js_1 = require(\"./JSHandle.js\");\n/**\n * @internal\n */\nclass UnserializableError extends Error {}\n/**\n * @internal\n */\nclass BidiSerializer {\n  static serializeNumber(arg) {\n    let value;\n    if (Object.is(arg, -0)) {\n      value = '-0';\n    } else if (Object.is(arg, Infinity)) {\n      value = 'Infinity';\n    } else if (Object.is(arg, -Infinity)) {\n      value = '-Infinity';\n    } else if (Object.is(arg, NaN)) {\n      value = 'NaN';\n    } else {\n      value = arg;\n    }\n    return {\n      type: 'number',\n      value\n    };\n  }\n  static serializeObject(arg) {\n    if (arg === null) {\n      return {\n        type: 'null'\n      };\n    } else if (Array.isArray(arg)) {\n      const parsedArray = arg.map(subArg => {\n        return BidiSerializer.serializeRemoveValue(subArg);\n      });\n      return {\n        type: 'array',\n        value: parsedArray\n      };\n    } else if ((0, util_js_1.isPlainObject)(arg)) {\n      try {\n        JSON.stringify(arg);\n      } catch (error) {\n        if (error instanceof TypeError && error.message.startsWith('Converting circular structure to JSON')) {\n          error.message += ' Recursive objects are not allowed.';\n        }\n        throw error;\n      }\n      const parsedObject = [];\n      for (const key in arg) {\n        parsedObject.push([BidiSerializer.serializeRemoveValue(key), BidiSerializer.serializeRemoveValue(arg[key])]);\n      }\n      return {\n        type: 'object',\n        value: parsedObject\n      };\n    } else if ((0, util_js_1.isRegExp)(arg)) {\n      return {\n        type: 'regexp',\n        value: {\n          pattern: arg.source,\n          flags: arg.flags\n        }\n      };\n    } else if ((0, util_js_1.isDate)(arg)) {\n      return {\n        type: 'date',\n        value: arg.toISOString()\n      };\n    }\n    throw new UnserializableError('Custom object sterilization not possible. Use plain objects instead.');\n  }\n  static serializeRemoveValue(arg) {\n    switch (typeof arg) {\n      case 'symbol':\n      case 'function':\n        throw new UnserializableError(`Unable to serializable ${typeof arg}`);\n      case 'object':\n        return BidiSerializer.serializeObject(arg);\n      case 'undefined':\n        return {\n          type: 'undefined'\n        };\n      case 'number':\n        return BidiSerializer.serializeNumber(arg);\n      case 'bigint':\n        return {\n          type: 'bigint',\n          value: arg.toString()\n        };\n      case 'string':\n        return {\n          type: 'string',\n          value: arg\n        };\n      case 'boolean':\n        return {\n          type: 'boolean',\n          value: arg\n        };\n    }\n  }\n  static serialize(arg, context) {\n    // TODO: See use case of LazyArgs\n    const objectHandle = arg && (arg instanceof JSHandle_js_1.JSHandle || arg instanceof ElementHandle_js_1.ElementHandle) ? arg : null;\n    if (objectHandle) {\n      if (objectHandle.context() !== context) {\n        throw new Error('JSHandles can be evaluated only in the context they were created!');\n      }\n      if (objectHandle.disposed) {\n        throw new Error('JSHandle is disposed!');\n      }\n      return objectHandle.remoteValue();\n    }\n    return BidiSerializer.serializeRemoveValue(arg);\n  }\n  static deserializeNumber(value) {\n    switch (value) {\n      case '-0':\n        return -0;\n      case 'NaN':\n        return NaN;\n      case 'Infinity':\n      case '+Infinity':\n        return Infinity;\n      case '-Infinity':\n        return -Infinity;\n      default:\n        return value;\n    }\n  }\n  static deserializeLocalValue(result) {\n    var _a;\n    switch (result.type) {\n      case 'array':\n        // TODO: Check expected output when value is undefined\n        return (_a = result.value) === null || _a === void 0 ? void 0 : _a.map(value => {\n          return BidiSerializer.deserializeLocalValue(value);\n        });\n      case 'set':\n        // TODO: Check expected output when value is undefined\n        return result.value.reduce((acc, value) => {\n          return acc.add(BidiSerializer.deserializeLocalValue(value));\n        }, new Set());\n      case 'object':\n        if (result.value) {\n          return result.value.reduce((acc, tuple) => {\n            const {\n              key,\n              value\n            } = BidiSerializer.deserializeTuple(tuple);\n            acc[key] = value;\n            return acc;\n          }, {});\n        }\n        break;\n      case 'map':\n        return result.value.reduce((acc, tuple) => {\n          const {\n            key,\n            value\n          } = BidiSerializer.deserializeTuple(tuple);\n          return acc.set(key, value);\n        }, new Map());\n      case 'promise':\n        return {};\n      case 'regexp':\n        return new RegExp(result.value.pattern, result.value.flags);\n      case 'date':\n        return new Date(result.value);\n      case 'undefined':\n        return undefined;\n      case 'null':\n        return null;\n      case 'number':\n        return BidiSerializer.deserializeNumber(result.value);\n      case 'bigint':\n        return BigInt(result.value);\n      case 'boolean':\n        return Boolean(result.value);\n      case 'string':\n        return result.value;\n    }\n    throw new UnserializableError(`Deserialization of type ${result.type} not supported.`);\n  }\n  static deserializeTuple([serializedKey, serializedValue]) {\n    const key = typeof serializedKey === 'string' ? serializedKey : BidiSerializer.deserializeLocalValue(serializedKey);\n    const value = BidiSerializer.deserializeLocalValue(serializedValue);\n    return {\n      key,\n      value\n    };\n  }\n  static deserialize(result) {\n    if (!result) {\n      (0, util_js_1.debugError)('Service did not produce a result.');\n      return undefined;\n    }\n    try {\n      return BidiSerializer.deserializeLocalValue(result);\n    } catch (error) {\n      if (error instanceof UnserializableError) {\n        (0, util_js_1.debugError)(error.message);\n        return undefined;\n      }\n      throw error;\n    }\n  }\n}\nexports.BidiSerializer = BidiSerializer;","map":{"version":3,"names":["util_js_1","require","ElementHandle_js_1","JSHandle_js_1","UnserializableError","Error","BidiSerializer","serializeNumber","arg","value","Object","is","Infinity","NaN","type","serializeObject","Array","isArray","parsedArray","map","subArg","serializeRemoveValue","isPlainObject","JSON","stringify","error","TypeError","message","startsWith","parsedObject","key","push","isRegExp","pattern","source","flags","isDate","toISOString","toString","serialize","context","objectHandle","JSHandle","ElementHandle","disposed","remoteValue","deserializeNumber","deserializeLocalValue","result","_a","reduce","acc","add","Set","tuple","deserializeTuple","set","Map","RegExp","Date","undefined","BigInt","Boolean","serializedKey","serializedValue","deserialize","debugError","exports"],"sources":["../../../../../src/common/bidi/Serializer.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}