{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2023 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.downloadFile = exports.httpRequest = exports.headHttpRequest = void 0;\nconst fs_1 = require(\"fs\");\nconst http = __importStar(require(\"http\"));\nconst https = __importStar(require(\"https\"));\nconst url_1 = require(\"url\");\nconst https_proxy_agent_1 = __importDefault(require(\"https-proxy-agent\"));\nconst proxy_from_env_1 = require(\"proxy-from-env\");\nfunction headHttpRequest(url) {\n  return new Promise(resolve => {\n    const request = httpRequest(url, 'HEAD', response => {\n      resolve(response.statusCode === 200);\n    }, false);\n    request.on('error', () => {\n      resolve(false);\n    });\n  });\n}\nexports.headHttpRequest = headHttpRequest;\nfunction httpRequest(url, method, response, keepAlive = true) {\n  const options = {\n    protocol: url.protocol,\n    hostname: url.hostname,\n    port: url.port,\n    path: url.pathname + url.search,\n    method,\n    headers: keepAlive ? {\n      Connection: 'keep-alive'\n    } : undefined\n  };\n  const proxyURL = (0, proxy_from_env_1.getProxyForUrl)(url.toString());\n  if (proxyURL) {\n    const proxy = new url_1.URL(proxyURL);\n    if (proxy.protocol === 'http:') {\n      options.path = url.href;\n      options.hostname = proxy.hostname;\n      options.protocol = proxy.protocol;\n      options.port = proxy.port;\n    } else {\n      options.agent = (0, https_proxy_agent_1.default)({\n        host: proxy.host,\n        path: proxy.pathname,\n        port: proxy.port,\n        secureProxy: proxy.protocol === 'https:',\n        headers: options.headers\n      });\n    }\n  }\n  const requestCallback = res => {\n    if (res.statusCode && res.statusCode >= 300 && res.statusCode < 400 && res.headers.location) {\n      httpRequest(new url_1.URL(res.headers.location), method, response);\n    } else {\n      response(res);\n    }\n  };\n  const request = options.protocol === 'https:' ? https.request(options, requestCallback) : http.request(options, requestCallback);\n  request.end();\n  return request;\n}\nexports.httpRequest = httpRequest;\n/**\n * @internal\n */\nfunction downloadFile(url, destinationPath, progressCallback) {\n  return new Promise((resolve, reject) => {\n    let downloadedBytes = 0;\n    let totalBytes = 0;\n    function onData(chunk) {\n      downloadedBytes += chunk.length;\n      progressCallback(downloadedBytes, totalBytes);\n    }\n    const request = httpRequest(url, 'GET', response => {\n      if (response.statusCode !== 200) {\n        const error = new Error(`Download failed: server returned code ${response.statusCode}. URL: ${url}`);\n        // consume response data to free up memory\n        response.resume();\n        reject(error);\n        return;\n      }\n      const file = (0, fs_1.createWriteStream)(destinationPath);\n      file.on('finish', () => {\n        return resolve();\n      });\n      file.on('error', error => {\n        return reject(error);\n      });\n      response.pipe(file);\n      totalBytes = parseInt(response.headers['content-length'], 10);\n      if (progressCallback) {\n        response.on('data', onData);\n      }\n    });\n    request.on('error', error => {\n      return reject(error);\n    });\n  });\n}\nexports.downloadFile = downloadFile;","map":{"version":3,"names":["fs_1","require","http","__importStar","https","url_1","https_proxy_agent_1","__importDefault","proxy_from_env_1","headHttpRequest","url","Promise","resolve","request","httpRequest","response","statusCode","on","exports","method","keepAlive","options","protocol","hostname","port","path","pathname","search","headers","Connection","undefined","proxyURL","getProxyForUrl","toString","proxy","URL","href","agent","default","host","secureProxy","requestCallback","res","location","end","downloadFile","destinationPath","progressCallback","reject","downloadedBytes","totalBytes","onData","chunk","length","error","Error","resume","file","createWriteStream","pipe","parseInt"],"sources":["../../src/httpUtil.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}