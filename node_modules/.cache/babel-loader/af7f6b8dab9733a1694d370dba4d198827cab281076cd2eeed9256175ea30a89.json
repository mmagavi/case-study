{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2023 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nvar __classPrivateFieldSet = this && this.__classPrivateFieldSet || function (receiver, state, value, kind, f) {\n  if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\n  return kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value), value;\n};\nvar __classPrivateFieldGet = this && this.__classPrivateFieldGet || function (receiver, state, kind, f) {\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\n  return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\n};\nvar _CDPConnectionAdapter_cdp, _CDPConnectionAdapter_adapters, _CDPConnectionAdapter_browser, _CDPClientAdapter_closed, _CDPClientAdapter_client, _CDPClientAdapter_forwardMessage, _NoOpTransport_onMessage;\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.connectBidiOverCDP = void 0;\nconst BidiMapper = __importStar(require(\"chromium-bidi/lib/cjs/bidiMapper/bidiMapper.js\"));\nconst Connection_js_1 = require(\"./Connection.js\");\n/**\n * @internal\n */\nasync function connectBidiOverCDP(cdp) {\n  const transportBiDi = new NoOpTransport();\n  const cdpConnectionAdapter = new CDPConnectionAdapter(cdp);\n  const pptrTransport = {\n    send(message) {\n      // Forwards a BiDi command sent by Puppeteer to the input of the BidiServer.\n      transportBiDi.emitMessage(JSON.parse(message));\n    },\n    close() {\n      bidiServer.close();\n      cdpConnectionAdapter.close();\n    },\n    onmessage(_message) {\n      // The method is overridden by the Connection.\n    }\n  };\n  transportBiDi.on('bidiResponse', message => {\n    // Forwards a BiDi event sent by BidiServer to Puppeteer.\n    pptrTransport.onmessage(JSON.stringify(message));\n  });\n  const pptrBiDiConnection = new Connection_js_1.Connection(pptrTransport);\n  const bidiServer = await BidiMapper.BidiServer.createAndStart(transportBiDi, cdpConnectionAdapter, '');\n  return pptrBiDiConnection;\n}\nexports.connectBidiOverCDP = connectBidiOverCDP;\n/**\n * Manages CDPSessions for BidiServer.\n * @internal\n */\nclass CDPConnectionAdapter {\n  constructor(cdp) {\n    _CDPConnectionAdapter_cdp.set(this, void 0);\n    _CDPConnectionAdapter_adapters.set(this, new Map());\n    _CDPConnectionAdapter_browser.set(this, void 0);\n    __classPrivateFieldSet(this, _CDPConnectionAdapter_cdp, cdp, \"f\");\n    __classPrivateFieldSet(this, _CDPConnectionAdapter_browser, new CDPClientAdapter(cdp), \"f\");\n  }\n  browserClient() {\n    return __classPrivateFieldGet(this, _CDPConnectionAdapter_browser, \"f\");\n  }\n  getCdpClient(id) {\n    const session = __classPrivateFieldGet(this, _CDPConnectionAdapter_cdp, \"f\").session(id);\n    if (!session) {\n      throw new Error('Unknown CDP session with id' + id);\n    }\n    if (!__classPrivateFieldGet(this, _CDPConnectionAdapter_adapters, \"f\").has(session)) {\n      const adapter = new CDPClientAdapter(session);\n      __classPrivateFieldGet(this, _CDPConnectionAdapter_adapters, \"f\").set(session, adapter);\n      return adapter;\n    }\n    return __classPrivateFieldGet(this, _CDPConnectionAdapter_adapters, \"f\").get(session);\n  }\n  close() {\n    __classPrivateFieldGet(this, _CDPConnectionAdapter_browser, \"f\").close();\n    for (const adapter of __classPrivateFieldGet(this, _CDPConnectionAdapter_adapters, \"f\").values()) {\n      adapter.close();\n    }\n  }\n}\n_CDPConnectionAdapter_cdp = new WeakMap(), _CDPConnectionAdapter_adapters = new WeakMap(), _CDPConnectionAdapter_browser = new WeakMap();\n/**\n * Wrapper on top of CDPSession/CDPConnection to satisfy CDP interface that\n * BidiServer needs.\n *\n * @internal\n */\nclass CDPClientAdapter extends BidiMapper.EventEmitter {\n  constructor(client) {\n    super();\n    _CDPClientAdapter_closed.set(this, false);\n    _CDPClientAdapter_client.set(this, void 0);\n    _CDPClientAdapter_forwardMessage.set(this, (method, event) => {\n      this.emit(method, event);\n    });\n    __classPrivateFieldSet(this, _CDPClientAdapter_client, client, \"f\");\n    __classPrivateFieldGet(this, _CDPClientAdapter_client, \"f\").on('*', __classPrivateFieldGet(this, _CDPClientAdapter_forwardMessage, \"f\"));\n  }\n  async sendCommand(method, ...params) {\n    if (__classPrivateFieldGet(this, _CDPClientAdapter_closed, \"f\")) {\n      return;\n    }\n    try {\n      return await __classPrivateFieldGet(this, _CDPClientAdapter_client, \"f\").send(method, ...params);\n    } catch (err) {\n      if (__classPrivateFieldGet(this, _CDPClientAdapter_closed, \"f\")) {\n        return;\n      }\n      throw err;\n    }\n  }\n  close() {\n    __classPrivateFieldGet(this, _CDPClientAdapter_client, \"f\").off('*', __classPrivateFieldGet(this, _CDPClientAdapter_forwardMessage, \"f\"));\n    __classPrivateFieldSet(this, _CDPClientAdapter_closed, true, \"f\");\n  }\n}\n_CDPClientAdapter_closed = new WeakMap(), _CDPClientAdapter_client = new WeakMap(), _CDPClientAdapter_forwardMessage = new WeakMap();\n/**\n * This transport is given to the BiDi server instance and allows Puppeteer\n * to send and receive commands to the BiDiServer.\n * @internal\n */\nclass NoOpTransport extends BidiMapper.EventEmitter {\n  constructor() {\n    super(...arguments);\n    _NoOpTransport_onMessage.set(this, async _m => {\n      return;\n    });\n  }\n  emitMessage(message) {\n    __classPrivateFieldGet(this, _NoOpTransport_onMessage, \"f\").call(this, message);\n  }\n  setOnMessage(onMessage) {\n    __classPrivateFieldSet(this, _NoOpTransport_onMessage, onMessage, \"f\");\n  }\n  async sendMessage(message) {\n    this.emit('bidiResponse', message);\n  }\n  close() {\n    __classPrivateFieldSet(this, _NoOpTransport_onMessage, async _m => {\n      return;\n    }, \"f\");\n  }\n}\n_NoOpTransport_onMessage = new WeakMap();","map":{"version":3,"names":["BidiMapper","__importStar","require","Connection_js_1","connectBidiOverCDP","cdp","transportBiDi","NoOpTransport","cdpConnectionAdapter","CDPConnectionAdapter","pptrTransport","send","message","emitMessage","JSON","parse","close","bidiServer","onmessage","_message","on","stringify","pptrBiDiConnection","Connection","BidiServer","createAndStart","exports","constructor","_CDPConnectionAdapter_cdp","set","_CDPConnectionAdapter_adapters","Map","_CDPConnectionAdapter_browser","__classPrivateFieldSet","CDPClientAdapter","browserClient","__classPrivateFieldGet","getCdpClient","id","session","Error","has","adapter","get","values","EventEmitter","client","_CDPClientAdapter_closed","_CDPClientAdapter_client","_CDPClientAdapter_forwardMessage","method","event","emit","sendCommand","params","err","off","_NoOpTransport_onMessage","_m","call","setOnMessage","onMessage","sendMessage"],"sources":["../../../../../src/common/bidi/BidiOverCDP.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}