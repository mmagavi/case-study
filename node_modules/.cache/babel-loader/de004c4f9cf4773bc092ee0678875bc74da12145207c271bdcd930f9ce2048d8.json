{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2022 Google LLC.\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.BrowsingContextImpl = void 0;\nconst unitConversions_js_1 = require(\"../../../utils/unitConversions.js\");\nconst protocol_js_1 = require(\"../../../protocol/protocol.js\");\nconst log_js_1 = require(\"../../../utils/log.js\");\nconst deferred_js_1 = require(\"../../../utils/deferred.js\");\nconst realm_js_1 = require(\"../script/realm.js\");\nclass BrowsingContextImpl {\n  /** The ID of the current context. */\n  #contextId;\n  /**\n   * The ID of the parent context.\n   * If null, this is a top-level context.\n   */\n  #parentId;\n  /**\n   * Children contexts.\n   * Map from children context ID to context implementation.\n   */\n  #children = new Map();\n  #browsingContextStorage;\n  #defers = {\n    documentInitialized: new deferred_js_1.Deferred(),\n    Page: {\n      navigatedWithinDocument: new deferred_js_1.Deferred(),\n      lifecycleEvent: {\n        DOMContentLoaded: new deferred_js_1.Deferred(),\n        load: new deferred_js_1.Deferred()\n      }\n    }\n  };\n  #url = 'about:blank';\n  #eventManager;\n  #realmStorage;\n  #loaderId = null;\n  #cdpTarget;\n  #maybeDefaultRealm;\n  #logger;\n  constructor(cdpTarget, realmStorage, contextId, parentId, eventManager, browsingContextStorage, logger) {\n    this.#cdpTarget = cdpTarget;\n    this.#realmStorage = realmStorage;\n    this.#contextId = contextId;\n    this.#parentId = parentId;\n    this.#eventManager = eventManager;\n    this.#browsingContextStorage = browsingContextStorage;\n    this.#logger = logger;\n    this.#initListeners();\n  }\n  static create(cdpTarget, realmStorage, contextId, parentId, eventManager, browsingContextStorage, logger) {\n    const context = new BrowsingContextImpl(cdpTarget, realmStorage, contextId, parentId, eventManager, browsingContextStorage, logger);\n    browsingContextStorage.addContext(context);\n    eventManager.registerEvent({\n      method: protocol_js_1.BrowsingContext.EventNames.ContextCreatedEvent,\n      params: context.serializeToBidiValue()\n    }, context.contextId);\n    return context;\n  }\n  /**\n   * @see https://html.spec.whatwg.org/multipage/document-sequences.html#navigable\n   */\n  get navigableId() {\n    return this.#loaderId;\n  }\n  delete() {\n    this.#deleteChildren();\n    this.#realmStorage.deleteRealms({\n      browsingContextId: this.contextId\n    });\n    // Remove context from the parent.\n    if (this.parentId !== null) {\n      const parent = this.#browsingContextStorage.getContext(this.parentId);\n      parent.#children.delete(this.contextId);\n    }\n    this.#eventManager.registerEvent({\n      method: protocol_js_1.BrowsingContext.EventNames.ContextDestroyedEvent,\n      params: this.serializeToBidiValue()\n    }, this.contextId);\n    this.#browsingContextStorage.deleteContext(this.contextId);\n  }\n  /** Returns the ID of this context. */\n  get contextId() {\n    return this.#contextId;\n  }\n  /** Returns the parent context ID. */\n  get parentId() {\n    return this.#parentId;\n  }\n  /** Returns all children contexts. */\n  get children() {\n    return Array.from(this.#children.values());\n  }\n  /**\n   * Returns true if this is a top-level context.\n   * This is the case whenever the parent context ID is null.\n   */\n  isTopLevelContext() {\n    return this.#parentId === null;\n  }\n  addChild(child) {\n    this.#children.set(child.contextId, child);\n  }\n  #deleteChildren() {\n    this.children.map(child => child.delete());\n  }\n  get #defaultRealm() {\n    if (this.#maybeDefaultRealm === undefined) {\n      throw new Error(`No default realm for browsing context ${this.#contextId}`);\n    }\n    return this.#maybeDefaultRealm;\n  }\n  get cdpTarget() {\n    return this.#cdpTarget;\n  }\n  updateCdpTarget(cdpTarget) {\n    this.#cdpTarget = cdpTarget;\n    this.#initListeners();\n  }\n  get url() {\n    return this.#url;\n  }\n  async awaitLoaded() {\n    await this.#defers.Page.lifecycleEvent.load;\n  }\n  awaitUnblocked() {\n    return this.#cdpTarget.targetUnblocked;\n  }\n  async getOrCreateSandbox(sandbox) {\n    if (sandbox === undefined || sandbox === '') {\n      return this.#defaultRealm;\n    }\n    let maybeSandboxes = this.#realmStorage.findRealms({\n      browsingContextId: this.contextId,\n      sandbox\n    });\n    if (maybeSandboxes.length === 0) {\n      await this.#cdpTarget.cdpClient.sendCommand('Page.createIsolatedWorld', {\n        frameId: this.contextId,\n        worldName: sandbox\n      });\n      // `Runtime.executionContextCreated` should be emitted by the time the\n      // previous command is done.\n      maybeSandboxes = this.#realmStorage.findRealms({\n        browsingContextId: this.contextId,\n        sandbox\n      });\n    }\n    if (maybeSandboxes.length !== 1) {\n      throw Error(`Sandbox ${sandbox} wasn't created.`);\n    }\n    return maybeSandboxes[0];\n  }\n  serializeToBidiValue(maxDepth = 0, addParentFiled = true) {\n    return {\n      context: this.#contextId,\n      url: this.url,\n      children: maxDepth > 0 ? this.children.map(c => c.serializeToBidiValue(maxDepth - 1, false)) : null,\n      ...(addParentFiled ? {\n        parent: this.#parentId\n      } : {})\n    };\n  }\n  #initListeners() {\n    this.#cdpTarget.cdpClient.on('Target.targetInfoChanged', params => {\n      if (this.contextId !== params.targetInfo.targetId) {\n        return;\n      }\n      this.#url = params.targetInfo.url;\n    });\n    this.#cdpTarget.cdpClient.on('Page.frameNavigated', params => {\n      if (this.contextId !== params.frame.id) {\n        return;\n      }\n      this.#url = params.frame.url + (params.frame.urlFragment ?? '');\n      // At the point the page is initiated, all the nested iframes from the\n      // previous page are detached and realms are destroyed.\n      // Remove context's children.\n      this.#deleteChildren();\n    });\n    this.#cdpTarget.cdpClient.on('Page.navigatedWithinDocument', params => {\n      if (this.contextId !== params.frameId) {\n        return;\n      }\n      this.#url = params.url;\n      this.#defers.Page.navigatedWithinDocument.resolve(params);\n    });\n    this.#cdpTarget.cdpClient.on('Page.lifecycleEvent', params => {\n      if (this.contextId !== params.frameId) {\n        return;\n      }\n      // `timestamp` from the event is MonotonicTime, not real time, so\n      // the best Mapper can do is to set the timestamp to the epoch time\n      // of the event arrived.\n      // https://chromedevtools.github.io/devtools-protocol/tot/Network/#type-MonotonicTime\n      const timestamp = new Date().getTime();\n      if (params.name === 'init') {\n        this.#documentChanged(params.loaderId);\n        this.#defers.documentInitialized.resolve();\n      }\n      if (params.name === 'commit') {\n        this.#loaderId = params.loaderId;\n        return;\n      }\n      if (params.loaderId !== this.#loaderId) {\n        return;\n      }\n      switch (params.name) {\n        case 'DOMContentLoaded':\n          this.#defers.Page.lifecycleEvent.DOMContentLoaded.resolve(params);\n          this.#eventManager.registerEvent({\n            method: protocol_js_1.BrowsingContext.EventNames.DomContentLoadedEvent,\n            params: {\n              context: this.contextId,\n              navigation: this.#loaderId,\n              timestamp,\n              url: this.#url\n            }\n          }, this.contextId);\n          break;\n        case 'load':\n          this.#defers.Page.lifecycleEvent.load.resolve(params);\n          this.#eventManager.registerEvent({\n            method: protocol_js_1.BrowsingContext.EventNames.LoadEvent,\n            params: {\n              context: this.contextId,\n              navigation: this.#loaderId,\n              timestamp,\n              url: this.#url\n            }\n          }, this.contextId);\n          break;\n      }\n    });\n    this.#cdpTarget.cdpClient.on('Runtime.executionContextCreated', params => {\n      if (params.context.auxData.frameId !== this.contextId) {\n        return;\n      }\n      // Only this execution contexts are supported for now.\n      if (!['default', 'isolated'].includes(params.context.auxData.type)) {\n        return;\n      }\n      const realm = new realm_js_1.Realm(this.#realmStorage, this.#browsingContextStorage, params.context.uniqueId, this.contextId, params.context.id, this.#getOrigin(params),\n      // TODO: differentiate types.\n      'window',\n      // Sandbox name for isolated world.\n      params.context.auxData.type === 'isolated' ? params.context.name : undefined, this.#cdpTarget.cdpSessionId, this.#cdpTarget.cdpClient, this.#eventManager);\n      if (params.context.auxData.isDefault) {\n        this.#maybeDefaultRealm = realm;\n      }\n    });\n    this.#cdpTarget.cdpClient.on('Runtime.executionContextDestroyed', params => {\n      this.#realmStorage.deleteRealms({\n        cdpSessionId: this.#cdpTarget.cdpSessionId,\n        executionContextId: params.executionContextId\n      });\n    });\n    this.#cdpTarget.cdpClient.on('Runtime.executionContextsCleared', () => {\n      this.#realmStorage.deleteRealms({\n        cdpSessionId: this.#cdpTarget.cdpSessionId\n      });\n    });\n  }\n  #getOrigin(params) {\n    if (params.context.auxData.type === 'isolated') {\n      // Sandbox should have the same origin as the context itself, but in CDP\n      // it has an empty one.\n      return this.#defaultRealm.origin;\n    }\n    // https://html.spec.whatwg.org/multipage/origin.html#ascii-serialisation-of-an-origin\n    return ['://', ''].includes(params.context.origin) ? 'null' : params.context.origin;\n  }\n  #documentChanged(loaderId) {\n    // Same document navigation.\n    if (loaderId === undefined || this.#loaderId === loaderId) {\n      if (this.#defers.Page.navigatedWithinDocument.isFinished) {\n        this.#defers.Page.navigatedWithinDocument = new deferred_js_1.Deferred();\n      }\n      return;\n    }\n    if (this.#defers.documentInitialized.isFinished) {\n      this.#defers.documentInitialized = new deferred_js_1.Deferred();\n    } else {\n      this.#logger?.(log_js_1.LogType.browsingContexts, 'Document changed');\n    }\n    if (this.#defers.Page.lifecycleEvent.DOMContentLoaded.isFinished) {\n      this.#defers.Page.lifecycleEvent.DOMContentLoaded = new deferred_js_1.Deferred();\n    } else {\n      this.#logger?.(log_js_1.LogType.browsingContexts, 'Document changed');\n    }\n    if (this.#defers.Page.lifecycleEvent.load.isFinished) {\n      this.#defers.Page.lifecycleEvent.load = new deferred_js_1.Deferred();\n    } else {\n      this.#logger?.(log_js_1.LogType.browsingContexts, 'Document changed');\n    }\n    this.#loaderId = loaderId;\n  }\n  async navigate(url, wait) {\n    await this.awaitUnblocked();\n    // TODO: handle loading errors.\n    const cdpNavigateResult = await this.#cdpTarget.cdpClient.sendCommand('Page.navigate', {\n      url,\n      frameId: this.contextId\n    });\n    if (cdpNavigateResult.errorText) {\n      throw new protocol_js_1.Message.UnknownErrorException(cdpNavigateResult.errorText);\n    }\n    this.#documentChanged(cdpNavigateResult.loaderId);\n    // Wait for `wait` condition.\n    switch (wait) {\n      case 'none':\n        break;\n      case 'interactive':\n        // No `loaderId` means same-document navigation.\n        if (cdpNavigateResult.loaderId === undefined) {\n          await this.#defers.Page.navigatedWithinDocument;\n        } else {\n          await this.#defers.Page.lifecycleEvent.DOMContentLoaded;\n        }\n        break;\n      case 'complete':\n        // No `loaderId` means same-document navigation.\n        if (cdpNavigateResult.loaderId === undefined) {\n          await this.#defers.Page.navigatedWithinDocument;\n        } else {\n          await this.#defers.Page.lifecycleEvent.load;\n        }\n        break;\n    }\n    return {\n      result: {\n        navigation: cdpNavigateResult.loaderId || null,\n        url\n      }\n    };\n  }\n  async captureScreenshot() {\n    const [, result] = await Promise.all([\n    // TODO: Either make this a proposal in the BiDi spec, or focus the\n    // original tab right after the screenshot is taken.\n    // The screenshot command gets blocked until we focus the active tab.\n    this.#cdpTarget.cdpClient.sendCommand('Page.bringToFront'), this.#cdpTarget.cdpClient.sendCommand('Page.captureScreenshot', {})]);\n    return {\n      result: {\n        data: result.data\n      }\n    };\n  }\n  async print(params) {\n    const printToPdfCdpParams = {\n      printBackground: params.background,\n      landscape: params.orientation === 'landscape',\n      pageRanges: params.pageRanges?.join(',') ?? '',\n      scale: params.scale,\n      preferCSSPageSize: !params.shrinkToFit\n    };\n    if (params.margin?.bottom) {\n      printToPdfCdpParams.marginBottom = (0, unitConversions_js_1.inchesFromCm)(params.margin.bottom);\n    }\n    if (params.margin?.left) {\n      printToPdfCdpParams.marginLeft = (0, unitConversions_js_1.inchesFromCm)(params.margin.left);\n    }\n    if (params.margin?.right) {\n      printToPdfCdpParams.marginRight = (0, unitConversions_js_1.inchesFromCm)(params.margin.right);\n    }\n    if (params.margin?.top) {\n      printToPdfCdpParams.marginTop = (0, unitConversions_js_1.inchesFromCm)(params.margin.top);\n    }\n    if (params.page?.height) {\n      printToPdfCdpParams.paperHeight = (0, unitConversions_js_1.inchesFromCm)(params.page.height);\n    }\n    if (params.page?.width) {\n      printToPdfCdpParams.paperWidth = (0, unitConversions_js_1.inchesFromCm)(params.page.width);\n    }\n    const result = await this.#cdpTarget.cdpClient.sendCommand('Page.printToPDF', printToPdfCdpParams);\n    return {\n      result: {\n        data: result.data\n      }\n    };\n  }\n  async addPreloadScript(params) {\n    const result = await this.#cdpTarget.cdpClient.sendCommand('Page.addScriptToEvaluateOnNewDocument', {\n      // The spec provides a function, and CDP expects an evaluation.\n      source: `(${params.expression})();`,\n      worldName: params.sandbox\n    });\n    return {\n      result: {\n        script: result.identifier\n      }\n    };\n  }\n}\nexports.BrowsingContextImpl = BrowsingContextImpl;","map":{"version":3,"names":["unitConversions_js_1","require","protocol_js_1","log_js_1","deferred_js_1","realm_js_1","BrowsingContextImpl","contextId","parentId","children","Map","browsingContextStorage","defers","documentInitialized","Deferred","Page","navigatedWithinDocument","lifecycleEvent","DOMContentLoaded","load","url","eventManager","realmStorage","loaderId","cdpTarget","maybeDefaultRealm","logger","constructor","initListeners","create","context","addContext","registerEvent","method","BrowsingContext","EventNames","ContextCreatedEvent","params","serializeToBidiValue","navigableId","delete","deleteChildren","deleteRealms","browsingContextId","parent","getContext","ContextDestroyedEvent","deleteContext","Array","from","values","isTopLevelContext","addChild","child","set","#deleteChildren","map","defaultRealm","#defaultRealm","undefined","Error","updateCdpTarget","awaitLoaded","awaitUnblocked","targetUnblocked","getOrCreateSandbox","sandbox","maybeSandboxes","findRealms","length","cdpClient","sendCommand","frameId","worldName","maxDepth","addParentFiled","c","#initListeners","on","targetInfo","targetId","frame","id","urlFragment","resolve","timestamp","Date","getTime","name","documentChanged","DomContentLoadedEvent","navigation","LoadEvent","auxData","includes","type","realm","Realm","uniqueId","getOrigin","cdpSessionId","isDefault","executionContextId","#getOrigin","origin","#documentChanged","isFinished","LogType","browsingContexts","navigate","wait","cdpNavigateResult","errorText","Message","UnknownErrorException","result","captureScreenshot","Promise","all","data","print","printToPdfCdpParams","printBackground","background","landscape","orientation","pageRanges","join","scale","preferCSSPageSize","shrinkToFit","margin","bottom","marginBottom","inchesFromCm","left","marginLeft","right","marginRight","top","marginTop","page","height","paperHeight","width","paperWidth","addPreloadScript","source","expression","script","identifier","exports"],"sources":["../../../../../src/bidiMapper/domains/context/browsingContextImpl.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}