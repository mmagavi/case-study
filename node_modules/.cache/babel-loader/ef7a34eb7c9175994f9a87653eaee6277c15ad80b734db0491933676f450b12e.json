{"ast":null,"code":"/**\n * Copyright 2017 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport assert from 'assert';\nimport { existsSync } from 'fs';\nimport { mkdir, unlink } from 'fs/promises';\nimport os from 'os';\nimport path from 'path';\nimport { downloadUrls } from './browser-data/browser-data.js';\nimport { Cache } from './Cache.js';\nimport { debug } from './debug.js';\nimport { detectBrowserPlatform } from './detectPlatform.js';\nimport { unpackArchive } from './fileUtil.js';\nimport { downloadFile, headHttpRequest } from './httpUtil.js';\nconst debugInstall = debug('puppeteer:browsers:install');\nconst times = new Map();\nfunction debugTime(label) {\n  times.set(label, process.hrtime());\n}\nfunction debugTimeEnd(label) {\n  const end = process.hrtime();\n  const start = times.get(label);\n  if (!start) {\n    return;\n  }\n  const duration = end[0] * 1000 + end[1] / 1e6 - (start[0] * 1000 + start[1] / 1e6); // calculate duration in milliseconds\n  debugInstall(`Duration for ${label}: ${duration}ms`);\n}\n/**\n * @public\n */\nexport async function install(options) {\n  var _a, _b;\n  (_a = options.platform) !== null && _a !== void 0 ? _a : options.platform = detectBrowserPlatform();\n  (_b = options.unpack) !== null && _b !== void 0 ? _b : options.unpack = true;\n  if (!options.platform) {\n    throw new Error(`Cannot download a binary for the provided platform: ${os.platform()} (${os.arch()})`);\n  }\n  const url = getDownloadUrl(options.browser, options.platform, options.buildId, options.baseUrl);\n  const fileName = url.toString().split('/').pop();\n  assert(fileName, `A malformed download URL was found: ${url}.`);\n  const structure = new Cache(options.cacheDir);\n  const browserRoot = structure.browserRoot(options.browser);\n  const archivePath = path.join(browserRoot, fileName);\n  if (!existsSync(browserRoot)) {\n    await mkdir(browserRoot, {\n      recursive: true\n    });\n  }\n  if (!options.unpack) {\n    if (existsSync(archivePath)) {\n      return {\n        path: archivePath,\n        browser: options.browser,\n        platform: options.platform,\n        buildId: options.buildId\n      };\n    }\n    debugInstall(`Downloading binary from ${url}`);\n    debugTime('download');\n    await downloadFile(url, archivePath, options.downloadProgressCallback);\n    debugTimeEnd('download');\n    return {\n      path: archivePath,\n      browser: options.browser,\n      platform: options.platform,\n      buildId: options.buildId\n    };\n  }\n  const outputPath = structure.installationDir(options.browser, options.platform, options.buildId);\n  if (existsSync(outputPath)) {\n    return {\n      path: outputPath,\n      browser: options.browser,\n      platform: options.platform,\n      buildId: options.buildId\n    };\n  }\n  try {\n    debugInstall(`Downloading binary from ${url}`);\n    try {\n      debugTime('download');\n      await downloadFile(url, archivePath, options.downloadProgressCallback);\n    } finally {\n      debugTimeEnd('download');\n    }\n    debugInstall(`Installing ${archivePath} to ${outputPath}`);\n    try {\n      debugTime('extract');\n      await unpackArchive(archivePath, outputPath);\n    } finally {\n      debugTimeEnd('extract');\n    }\n  } finally {\n    if (existsSync(archivePath)) {\n      await unlink(archivePath);\n    }\n  }\n  return {\n    path: outputPath,\n    browser: options.browser,\n    platform: options.platform,\n    buildId: options.buildId\n  };\n}\n/**\n * @public\n */\nexport async function canDownload(options) {\n  var _a;\n  (_a = options.platform) !== null && _a !== void 0 ? _a : options.platform = detectBrowserPlatform();\n  if (!options.platform) {\n    throw new Error(`Cannot download a binary for the provided platform: ${os.platform()} (${os.arch()})`);\n  }\n  return await headHttpRequest(getDownloadUrl(options.browser, options.platform, options.buildId, options.baseUrl));\n}\nfunction getDownloadUrl(browser, platform, buildId, baseUrl) {\n  return new URL(downloadUrls[browser](platform, buildId, baseUrl));\n}","map":{"version":3,"names":["assert","existsSync","mkdir","unlink","os","path","downloadUrls","Cache","debug","detectBrowserPlatform","unpackArchive","downloadFile","headHttpRequest","debugInstall","times","Map","debugTime","label","set","process","hrtime","debugTimeEnd","end","start","get","duration","install","options","_a","platform","_b","unpack","Error","arch","url","getDownloadUrl","browser","buildId","baseUrl","fileName","toString","split","pop","structure","cacheDir","browserRoot","archivePath","join","recursive","downloadProgressCallback","outputPath","installationDir","canDownload","URL"],"sources":["../../src/install.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}