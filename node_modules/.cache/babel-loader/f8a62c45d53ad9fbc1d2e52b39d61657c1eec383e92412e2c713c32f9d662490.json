{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2021 Google LLC.\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.CommandProcessor = void 0;\nconst protocol_js_1 = require(\"../protocol/protocol.js\");\nconst log_js_1 = require(\"../utils/log.js\");\nconst EventEmitter_js_1 = require(\"../utils/EventEmitter.js\");\nconst browsingContextProcessor_js_1 = require(\"./domains/context/browsingContextProcessor.js\");\nconst OutgoingBidiMessage_js_1 = require(\"./OutgoingBidiMessage.js\");\nclass BidiNoOpParser {\n  parseAddPreloadScriptParams(params) {\n    return params;\n  }\n  parseRemovePreloadScriptParams(params) {\n    return params;\n  }\n  parseGetRealmsParams(params) {\n    return params;\n  }\n  parseCallFunctionParams(params) {\n    return params;\n  }\n  parseEvaluateParams(params) {\n    return params;\n  }\n  parseDisownParams(params) {\n    return params;\n  }\n  parseSendCommandParams(params) {\n    return params;\n  }\n  parseGetSessionParams(params) {\n    return params;\n  }\n  parseSubscribeParams(params) {\n    return params;\n  }\n  parseNavigateParams(params) {\n    return params;\n  }\n  parseGetTreeParams(params) {\n    return params;\n  }\n  parseCreateParams(params) {\n    return params;\n  }\n  parseCloseParams(params) {\n    return params;\n  }\n  parseCaptureScreenshotParams(params) {\n    return params;\n  }\n  parsePrintParams(params) {\n    return params;\n  }\n}\nclass CommandProcessor extends EventEmitter_js_1.EventEmitter {\n  #contextProcessor;\n  #eventManager;\n  #parser;\n  #logger;\n  constructor(realmStorage, cdpConnection, eventManager, selfTargetId, parser = new BidiNoOpParser(), browsingContextStorage, logger) {\n    super();\n    this.#eventManager = eventManager;\n    this.#logger = logger;\n    this.#contextProcessor = new browsingContextProcessor_js_1.BrowsingContextProcessor(realmStorage, cdpConnection, selfTargetId, eventManager, browsingContextStorage, logger);\n    this.#parser = parser;\n  }\n  static #process_session_status() {\n    return {\n      result: {\n        ready: false,\n        message: 'already connected'\n      }\n    };\n  }\n  async #process_session_subscribe(params, channel) {\n    await this.#eventManager.subscribe(params.events, params.contexts ?? [null], channel);\n    return {\n      result: {}\n    };\n  }\n  async #process_session_unsubscribe(params, channel) {\n    await this.#eventManager.unsubscribe(params.events, params.contexts ?? [null], channel);\n    return {\n      result: {}\n    };\n  }\n  async #processCommand(commandData) {\n    switch (commandData.method) {\n      case 'session.status':\n        return CommandProcessor.#process_session_status();\n      case 'session.subscribe':\n        return this.#process_session_subscribe(this.#parser.parseSubscribeParams(commandData.params), commandData.channel ?? null);\n      case 'session.unsubscribe':\n        return this.#process_session_unsubscribe(this.#parser.parseSubscribeParams(commandData.params), commandData.channel ?? null);\n      case 'browsingContext.create':\n        return this.#contextProcessor.process_browsingContext_create(this.#parser.parseCreateParams(commandData.params));\n      case 'browsingContext.close':\n        return this.#contextProcessor.process_browsingContext_close(this.#parser.parseCloseParams(commandData.params));\n      case 'browsingContext.getTree':\n        return this.#contextProcessor.process_browsingContext_getTree(this.#parser.parseGetTreeParams(commandData.params));\n      case 'browsingContext.navigate':\n        return this.#contextProcessor.process_browsingContext_navigate(this.#parser.parseNavigateParams(commandData.params));\n      case 'browsingContext.captureScreenshot':\n        return this.#contextProcessor.process_browsingContext_captureScreenshot(this.#parser.parseCaptureScreenshotParams(commandData.params));\n      case 'browsingContext.print':\n        return this.#contextProcessor.process_browsingContext_print(this.#parser.parsePrintParams(commandData.params));\n      case 'script.addPreloadScript':\n        return this.#contextProcessor.process_script_addPreloadScript(this.#parser.parseAddPreloadScriptParams(commandData.params));\n      case 'script.removePreloadScript':\n        return this.#contextProcessor.process_script_removePreloadScript(this.#parser.parseRemovePreloadScriptParams(commandData.params));\n      case 'script.getRealms':\n        return this.#contextProcessor.process_script_getRealms(this.#parser.parseGetRealmsParams(commandData.params));\n      case 'script.callFunction':\n        return this.#contextProcessor.process_script_callFunction(this.#parser.parseCallFunctionParams(commandData.params));\n      case 'script.evaluate':\n        return this.#contextProcessor.process_script_evaluate(this.#parser.parseEvaluateParams(commandData.params));\n      case 'script.disown':\n        return this.#contextProcessor.process_script_disown(this.#parser.parseDisownParams(commandData.params));\n      case 'cdp.sendCommand':\n        return this.#contextProcessor.process_cdp_sendCommand(this.#parser.parseSendCommandParams(commandData.params));\n      case 'cdp.getSession':\n        return this.#contextProcessor.process_cdp_getSession(this.#parser.parseGetSessionParams(commandData.params));\n      default:\n        throw new protocol_js_1.Message.UnknownCommandException(`Unknown command '${commandData.method}'.`);\n    }\n  }\n  async processCommand(command) {\n    try {\n      const result = await this.#processCommand(command);\n      const response = {\n        id: command.id,\n        ...result\n      };\n      this.emit('response', OutgoingBidiMessage_js_1.OutgoingBidiMessage.createResolved(response, command.channel ?? null));\n    } catch (e) {\n      if (e instanceof protocol_js_1.Message.ErrorResponse) {\n        const errorResponse = e;\n        this.emit('response', OutgoingBidiMessage_js_1.OutgoingBidiMessage.createResolved(errorResponse.toErrorResponse(command.id), command.channel ?? null));\n      } else {\n        const error = e;\n        this.#logger?.(log_js_1.LogType.bidi, error);\n        this.emit('response', OutgoingBidiMessage_js_1.OutgoingBidiMessage.createResolved(new protocol_js_1.Message.ErrorResponse(protocol_js_1.Message.ErrorCode.UnknownError, error.message).toErrorResponse(command.id), command.channel ?? null));\n      }\n    }\n  }\n}\nexports.CommandProcessor = CommandProcessor;","map":{"version":3,"names":["protocol_js_1","require","log_js_1","EventEmitter_js_1","browsingContextProcessor_js_1","OutgoingBidiMessage_js_1","BidiNoOpParser","parseAddPreloadScriptParams","params","parseRemovePreloadScriptParams","parseGetRealmsParams","parseCallFunctionParams","parseEvaluateParams","parseDisownParams","parseSendCommandParams","parseGetSessionParams","parseSubscribeParams","parseNavigateParams","parseGetTreeParams","parseCreateParams","parseCloseParams","parseCaptureScreenshotParams","parsePrintParams","CommandProcessor","EventEmitter","contextProcessor","eventManager","parser","logger","constructor","realmStorage","cdpConnection","selfTargetId","browsingContextStorage","BrowsingContextProcessor","process_session_status","#process_session_status","result","ready","message","process_session_subscribe","#process_session_subscribe","channel","subscribe","events","contexts","process_session_unsubscribe","#process_session_unsubscribe","unsubscribe","processCommand","#processCommand","commandData","method","process_browsingContext_create","process_browsingContext_close","process_browsingContext_getTree","process_browsingContext_navigate","process_browsingContext_captureScreenshot","process_browsingContext_print","process_script_addPreloadScript","process_script_removePreloadScript","process_script_getRealms","process_script_callFunction","process_script_evaluate","process_script_disown","process_cdp_sendCommand","process_cdp_getSession","Message","UnknownCommandException","command","response","id","emit","OutgoingBidiMessage","createResolved","e","ErrorResponse","errorResponse","toErrorResponse","error","LogType","bidi","ErrorCode","UnknownError","exports"],"sources":["../../../src/bidiMapper/CommandProcessor.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}