{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2023 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.QueryHandler = void 0;\nconst ElementHandle_js_1 = require(\"../api/ElementHandle.js\");\nconst assert_js_1 = require(\"../util/assert.js\");\nconst ErrorLike_js_1 = require(\"../util/ErrorLike.js\");\nconst Function_js_1 = require(\"../util/Function.js\");\nconst Errors_js_1 = require(\"./Errors.js\");\nconst HandleIterator_js_1 = require(\"./HandleIterator.js\");\nconst IsolatedWorlds_js_1 = require(\"./IsolatedWorlds.js\");\nconst LazyArg_js_1 = require(\"./LazyArg.js\");\n/**\n * @internal\n */\nclass QueryHandler {\n  static get _querySelector() {\n    if (this.querySelector) {\n      return this.querySelector;\n    }\n    if (!this.querySelectorAll) {\n      throw new Error('Cannot create default `querySelector`.');\n    }\n    return this.querySelector = (0, Function_js_1.interpolateFunction)(async (node, selector, PuppeteerUtil) => {\n      const querySelectorAll = PLACEHOLDER('querySelectorAll');\n      const results = querySelectorAll(node, selector, PuppeteerUtil);\n      for await (const result of results) {\n        return result;\n      }\n      return null;\n    }, {\n      querySelectorAll: (0, Function_js_1.stringifyFunction)(this.querySelectorAll)\n    });\n  }\n  static get _querySelectorAll() {\n    if (this.querySelectorAll) {\n      return this.querySelectorAll;\n    }\n    if (!this.querySelector) {\n      throw new Error('Cannot create default `querySelectorAll`.');\n    }\n    return this.querySelectorAll = (0, Function_js_1.interpolateFunction)(async function* (node, selector, PuppeteerUtil) {\n      const querySelector = PLACEHOLDER('querySelector');\n      const result = await querySelector(node, selector, PuppeteerUtil);\n      if (result) {\n        yield result;\n      }\n    }, {\n      querySelector: (0, Function_js_1.stringifyFunction)(this.querySelector)\n    });\n  }\n  /**\n   * Queries for multiple nodes given a selector and {@link ElementHandle}.\n   *\n   * Akin to {@link https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelectorAll | Document.querySelectorAll()}.\n   */\n  static async *queryAll(element, selector) {\n    const world = element.executionContext()._world;\n    (0, assert_js_1.assert)(world);\n    const handle = await element.evaluateHandle(this._querySelectorAll, selector, LazyArg_js_1.LazyArg.create(context => {\n      return context.puppeteerUtil;\n    }));\n    yield* (0, HandleIterator_js_1.transposeIterableHandle)(handle);\n  }\n  /**\n   * Queries for a single node given a selector and {@link ElementHandle}.\n   *\n   * Akin to {@link https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelector}.\n   */\n  static async queryOne(element, selector) {\n    const world = element.executionContext()._world;\n    (0, assert_js_1.assert)(world);\n    const result = await element.evaluateHandle(this._querySelector, selector, LazyArg_js_1.LazyArg.create(context => {\n      return context.puppeteerUtil;\n    }));\n    if (!(result instanceof ElementHandle_js_1.ElementHandle)) {\n      await result.dispose();\n      return null;\n    }\n    return result;\n  }\n  /**\n   * Waits until a single node appears for a given selector and\n   * {@link ElementHandle}.\n   *\n   * This will always query the handle in the Puppeteer world and migrate the\n   * result to the main world.\n   */\n  static async waitFor(elementOrFrame, selector, options) {\n    let frame;\n    let element;\n    if (!(elementOrFrame instanceof ElementHandle_js_1.ElementHandle)) {\n      frame = elementOrFrame;\n    } else {\n      frame = elementOrFrame.frame;\n      element = await frame.worlds[IsolatedWorlds_js_1.PUPPETEER_WORLD].adoptHandle(elementOrFrame);\n    }\n    const {\n      visible = false,\n      hidden = false,\n      timeout,\n      signal\n    } = options;\n    try {\n      if (signal === null || signal === void 0 ? void 0 : signal.aborted) {\n        throw new Errors_js_1.AbortError('QueryHander.waitFor has been aborted.');\n      }\n      const handle = await frame.worlds[IsolatedWorlds_js_1.PUPPETEER_WORLD].waitForFunction(async (PuppeteerUtil, query, selector, root, visible) => {\n        const querySelector = PuppeteerUtil.createFunction(query);\n        const node = await querySelector(root !== null && root !== void 0 ? root : document, selector, PuppeteerUtil);\n        return PuppeteerUtil.checkVisibility(node, visible);\n      }, {\n        polling: visible || hidden ? 'raf' : 'mutation',\n        root: element,\n        timeout,\n        signal\n      }, LazyArg_js_1.LazyArg.create(context => {\n        return context.puppeteerUtil;\n      }), (0, Function_js_1.stringifyFunction)(this._querySelector), selector, element, visible ? true : hidden ? false : undefined);\n      if (signal === null || signal === void 0 ? void 0 : signal.aborted) {\n        await handle.dispose();\n        throw new Errors_js_1.AbortError('QueryHander.waitFor has been aborted.');\n      }\n      if (!(handle instanceof ElementHandle_js_1.ElementHandle)) {\n        await handle.dispose();\n        return null;\n      }\n      return frame.worlds[IsolatedWorlds_js_1.MAIN_WORLD].transferHandle(handle);\n    } catch (error) {\n      if (!(0, ErrorLike_js_1.isErrorLike)(error)) {\n        throw error;\n      }\n      error.message = `Waiting for selector \\`${selector}\\` failed: ${error.message}`;\n      throw error;\n    } finally {\n      if (element) {\n        await element.dispose();\n      }\n    }\n  }\n}\nexports.QueryHandler = QueryHandler;","map":{"version":3,"names":["ElementHandle_js_1","require","assert_js_1","ErrorLike_js_1","Function_js_1","Errors_js_1","HandleIterator_js_1","IsolatedWorlds_js_1","LazyArg_js_1","QueryHandler","_querySelector","querySelector","querySelectorAll","Error","interpolateFunction","node","selector","PuppeteerUtil","PLACEHOLDER","results","result","stringifyFunction","_querySelectorAll","queryAll","element","world","executionContext","_world","assert","handle","evaluateHandle","LazyArg","create","context","puppeteerUtil","transposeIterableHandle","queryOne","ElementHandle","dispose","waitFor","elementOrFrame","options","frame","worlds","PUPPETEER_WORLD","adoptHandle","visible","hidden","timeout","signal","aborted","AbortError","waitForFunction","query","root","createFunction","document","checkVisibility","polling","undefined","MAIN_WORLD","transferHandle","error","isErrorLike","message","exports"],"sources":["../../../../src/common/QueryHandler.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}